### 数据链路层-广播信道

广播信道可以进行一对多的通信，接下来讨论的局域网使用的就是广播信道

局域网最主要的特点是: 网络为一个单位所拥有，且地理范围和站点数目均有限

局域网的特点:

* 具有广播功能，从一个站点可以很方便地访问全网
* 便于系统的扩展和逐渐地演变，各设备的位置可灵活调整和改变
* 提高了系统的可靠性，可用性和生存性

共享信道要重点考虑的一个问题就是如何事众多用户能够合理而方便地共享通信媒体资源，这在
技术上有两种方法：

* 静态划分信道，比如物理层介绍的频分复用，时分复用，波分复用和码分复用等
* 动态媒体介入控制，它又成为多点接入，其特点是信道并非在用户通信时固定分配给用户，这里又分为以下两类:
    * 随机接入：随机接入的特点是所有的用户可随机地发送信息，但如果恰巧有两个或更多的用户在同一时刻发
        送信息，那么在共享媒体上就要产生`碰撞`，使得这些用户的发送都失败，因此，必须有解决碰撞的网络协议
    * 受控接入：受控接入的特点是用户不能随机地发送信息而必须服从一定的控制

为了使数据链路层能更好地适应多种局域网标准，IEEE 802委员会把局域网的数据链路层拆成两个字层：即
`逻辑链路控制LLC(Logical Link Control)`子层和`媒体接入控制MAC(Medium Access Control)`子层

于接入到传输媒体有关的内容都放在MAC字层，而LLC子层则与传输媒体无关，不管采用何种传输媒体和MAC字层的
局域网对LLC字层来说都是透明的

#### 适配器的作用

计算机与外界局域网的连接时通过通信`适配器(adapter)`,适配器本来是在主句箱内插入的一块网络接口板，
这种接口板又称为`网络接口卡NIC(Network Interface Card)`或简称为`网卡`；

现在的计算机主板上已经嵌入了这种适配器，不使用单独的网卡，所以接下来都称呼为适配器；在适配器上面
装有处理器和存储器（包括RAM和ROM）;适配器和局域网之间的通信是通过电缆或双绞线以串行传输方式
进行的，而适配器和计算机之间的通信则是通过计算机主板上的I/O总线以并行传输方式进行

适配器接收和发送各种帧时不使用计算机的CPU，这时CPU可以处理其他任务；当适配器收到有差错的帧
时，就把这个帧丢弃而不必通知计算机，当适配器收到正确的帧时，它就使用中断来通知该计算机并交付
给协议栈中的网络层；当计算机要发送IP数据报时，就由协议栈把IP数据报向下交给适配器，组装成帧
后发送给局域网

注意：计算机的硬件地址就在适配器的ROM中，而计算机的软件地址——IP地址，则在计算机的存储器中

#### CSMA/CD协议

最早的以太网是将许多计算机都连接到一个总线上，此时当一台计算机发送数据时，总线上的所有计算机
都能检测到这个数据，这就是`广播通信`方式；但我们并不总是要在局域网上进行一对多的广播通信，
为了在总线上实现一对一的通信，可以在发送数据帧时，在帧的首部写明接收站的地址，仅当数据帧
中哦你的目的地址与适配器的ROM中存放的硬件地址一致时，该适配器才能接收这个数据帧；适配器
对不是发送给自己的数据帧就丢弃，这样，具有广播特性的总线上就实现了一对一的通信

通信特点：

* 采用较为灵活的`无连接`的工作方式，即不必先建立连接就可以直接发送数据；适配器对发送的数据
    帧不进行编号，也不要求对方发回确认；因此，以太网提供的服务是不可靠的交互，即`尽最大努力的交互`
* 以太网发送的数据都使用曼切斯特编码信号

剩下一个重要的问题是如何协调总线上各计算机的工作，因为总线上只要有一台计算机在发送数据，
总线的传输资源就被占用；因此，在同一时间只允许一台计算机发送信息，否则各计算机之间会相互干扰，
结果大家都无法正常发送数据

以太网采用的协调方法是使用一种特殊的协议CSMA/CD, 它是载波监听多点接入/碰撞检测的缩写，
下面是CSMA/CD协议的要点：

* 多点接入：说明这是总线网络，许多计算机以多点接入的方式连接在一根总线上
* 载波监听：就是发送前先监听，即每一个站在发送数据之前要先检测一下总线上是否有其他站在发送
    数据
* 碰撞检测：就是边发送边监听，即适配器边发送数据边检测信道上的信号电压的变化情况，以便
    判断自己在发送数据时其他站是否也在发送数据

在局域网的分析中，常把总线上的单程端到端的传播时延极为t, 发送数据的站希望尽早知道是否发生了碰撞，
那么，A发送数据后，最迟要经过多长时间才能知道自己发送的数据和其他站发送的数据有没有碰撞了？
这个时间最迟是两倍的总线端到端传播时延2t,这个时间也成为争用期；

以太网把争用期定为51.2us， 对于10mb/s以太网，在争用期内可发送512bit，即64字节；也就是说，
如果帧的前64字节没有发生冲突，那么后续的数据就不会发生冲突；`凡长度小于64字节的帧都是由于`
`冲突而异常终止的无效帧`，收到这种无效帧应当立刻丢弃

##### MAC层的硬件地址

在局域网中，硬件地址又称为物理地址或MAC地址；IEEE802标准为局域网规定了一种48位的全球地址，
是指局域网上的每一台计算机中固化在适配器的ROM中的地址，因此：

* 假定链接在局域网上的一台计算机的适配器坏了而我们更换了一个新的适配器，那么这台计算机的
    局域网的`地址`也就改变了，虽然这台计算机的地理位置一点没有变化，所接入的局域网也没有任何改变
* 假定我们把位于南京的某局域网上的一台笔记本携带到北京，并连接在北京的某局域网上，虽然这台电脑
    的地理位置改变了，但只要电脑中的适配器不变，那么该电脑在北京的局域网中的`地址`仍然和它在
    南京的局域网中的`地址`一样

我们知道适配器有过滤功能，适配器从网络上每收到一个MAC帧就先用硬件检查MAC帧中的目的地址，
如果是发往本站的帧则手下，然后在进行其他的处理，否则就将此帧丢弃；但适配器还可设置为一种
特殊的工作方式，即混杂方式，在混杂方式的适配器只要`听到`有帧在以太网上传输就都悄悄地接收
下来，而不管这些帧是发往哪个站。这样做实际上是`窃听`其他站的通信而并不中断其他站点的通信，
一些黑客常利用这种方法非法获取网上用户的口令

##### MAC帧的格式

MAC帧格式有两种：DIX Ethernet V2标准和IEEE的802.3标准，下面介绍的是使用最多V2的MAC帧格式

![link_05](https://github.com/yangguangyong/yangguangyong-s-blog/blob/master/assets/2016/04/link_05.png)

V2的MAC帧由五个字段组成，前两个字段分别为6字节长的`目的地址`和`源地址`字段;第三个字段是
2字节的`类型字段`，用来标志上一层使用的是什么协议，以便把收到的MAC帧的数据上交给上一层
的这个协议；第四个字段是`数据字段`，长度在46到1500字节之间；最后一个字段是4字节的帧检验序列
FCS(使用CRC检验得出的冗余码)

小知识：为什么数据字段最小是46字节？前面说过了，以太网中帧的最小长度是64字节，如果小于64
字节收到的帧不是一个完整的帧，所以，整个帧64减去首部14字节，再减去尾部4字节，就得到46字节喽

下列情况之一的即为无效的MAC帧:

* 帧的长度不是整数个字节
* 用收到的帧检验序列FCS查出有差错
* 收到的帧的MAC客户数据字段的长度不再46～1500字节之间

#### 扩展以太网

扩展以太网可以在物理层扩展，也可以在数据链路层扩展

##### 物理层扩展以太网

物理层扩展以太网使用转发器

##### 数据链路层扩展以太网

数据链路层扩展以太网使用网桥，它根据MAC帧的目的地址对收到的帧进行转发和过滤，当网桥收到
一个帧时，并不是向所有的接口转发此帧，而是先检查此帧的目的MAC地址，然后在确定该帧转发到
哪一个接口，或者是把它丢弃

###### 网桥内部结构

最简单的网桥有两个接口，两个以太网通过网桥链接起来后，原来的每个以太网就可以称为一个网段(segment)

网桥依靠转发表来转发帧，转发表也叫做转发数据库或路由目录，后面讨论网桥的工作原理

使用网桥带来的好处：

* 过滤通信量，增大吞吐量
* 扩大物理范围
* 提高可靠性
* 可互联不同物理层，不同MAC字层和不同速率

###### 透明网桥

当网桥刚刚连接到以太网时，其转发表是空的，这时若网桥收到一个帧，它将通过以下自学习算法处理
收到的帧：若从某个站A发出的帧从接口x进入了某个网桥，那么从这个接口出发沿相反方向一定可把
一个帧传送到A;所以网桥只要每收到一个帧，就记下其源地址和进入网桥的接口，作为转发表中的一个
项目。在建立转发表时把帧首部中的源地址写在地址这一栏的下面，在转发帧时，则是根据收到的帧
首部中的目的地址来转发，这时就把地址栏下面已经记下的源地址当作目的地址，而把记下的进入接口
当作转发接口
